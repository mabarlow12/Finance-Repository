<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Forecast Model</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f9fafb;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 32px;
            color: #111827;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f3f4f6;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .sync-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
        }
        
        .sync-dot.syncing {
            background: #f59e0b;
            animation: pulse 1.5s infinite;
        }
        
        .sync-dot.error {
            background: #ef4444;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .btn {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #2563eb;
        }
        
        .btn.sync-btn {
            background: #10b981;
        }
        
        .btn.sync-btn:hover {
            background: #059669;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            white-space: nowrap;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            padding: 20px;
            border-radius: 8px;
            background: #f3f4f6;
        }
        
        .metric-card.purple { background: #ede9fe; }
        .metric-card.green { background: #d1fae5; }
        .metric-card.blue { background: #dbeafe; }
        .metric-card.yellow { background: #fef3c7; }
        .metric-card.orange { background: #fed7aa; }
        
        .metric-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: #111827;
        }
        
        .alert {
            background: #fff7ed;
            border-left: 4px solid #f97316;
            padding: 16px;
            margin-bottom: 30px;
            border-radius: 8px;
        }
        
        .info-box {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 16px;
            margin-bottom: 30px;
            border-radius: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        thead {
            background: #f9fafb;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            font-weight: 600;
            color: #111827;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-green { color: #059669; }
        .text-red { color: #dc2626; }
        .text-blue { color: #2563eb; }
        .text-purple { color: #7c3aed; }
        .text-orange { color: #ea580c; }
        
        .week-row {
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .week-row:hover {
            background: #f9fafb;
        }
        
        .week-row.negative {
            background: #fee2e2;
        }
        
        .week-details {
            display: none;
            background: #f9fafb;
            padding: 20px;
        }
        
        .week-details.show {
            display: block;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        input[type="number"],
        input[type="text"],
        input[type="date"],
        select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .item-row {
            display: grid;
            grid-template-columns: 40px 2fr 1fr 1fr 1fr 1fr 40px;
            gap: 10px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #3b82f6;
        }
        
        .section-title.business {
            color: #059669;
        }
        
        .remove-btn {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .add-btn {
            background: #059669;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .item-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Financial Forecast Model</h1>
            <div class="header-buttons">
                <div class="sync-status">
                    <div class="sync-dot" id="syncDot"></div>
                    <span id="syncStatus">Synced</span>
                </div>
                <button class="btn sync-btn" onclick="manualSync()">⟳ Sync Now</button>
                <button class="btn" onclick="downloadCSV()">Export CSV</button>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard', this)">Dashboard</button>
            <button class="tab" onclick="switchTab('weekly', this)">Weekly</button>
            <button class="tab" onclick="switchTab('income', this)">Income</button>
            <button class="tab" onclick="switchTab('expenses', this)">Expenses</button>
            <button class="tab" onclick="switchTab('debts', this)">Debts</button>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="metrics-grid">
                <div class="metric-card purple">
                    <div class="metric-label">Current Cash</div>
                    <div class="metric-value" id="currentCash">$20,000</div>
                </div>
                <div class="metric-card green">
                    <div class="metric-label">Cash (Dec 2026)</div>
                    <div class="metric-value" id="futureCash">$45,230</div>
                </div>
                <div class="metric-card blue">
                    <div class="metric-label">Avg Weekly Flow</div>
                    <div class="metric-value" id="avgFlow">$387</div>
                </div>
                <div class="metric-card yellow">
                    <div class="metric-label">Tax Owed (Apr 2027)</div>
                    <div class="metric-value" id="taxOwed">$16,380</div>
                </div>
                <div class="metric-card orange">
                    <div class="metric-label">Cash After Tax</div>
                    <div class="metric-value" id="afterTax">$28,850</div>
                </div>
            </div>
            
            <div class="info-box">
                <strong>Multi-Device Sync Enabled</strong><br>
                Your data automatically syncs to Google Sheets and is accessible from any device. Last synced: <span id="lastSync">Just now</span>
            </div>
            
            <h3 style="margin-bottom: 15px;">5-Week Cash Flow Outlook</h3>
            <table>
                <thead>
                    <tr>
                        <th>Week</th>
                        <th class="text-right">Income</th>
                        <th class="text-right">Expenses</th>
                        <th class="text-right">Debt</th>
                        <th class="text-right">Cash Flow</th>
                        <th class="text-right">Balance</th>
                    </tr>
                </thead>
                <tbody id="outlookTable">
                    <!-- Generated by JS -->
                </tbody>
            </table>
            
            <canvas id="cashChart" style="max-height: 400px;"></canvas>
        </div>
        
        <!-- Weekly Tab -->
        <div id="weekly" class="tab-content">
            <div style="background: #dbeafe; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <label style="font-weight: 500;">Starting Cash Balance: </label>
                <input type="number" id="startingCash" value="20000" onchange="updateStartingCash()" style="margin-left: 10px; font-weight: bold;">
            </div>
            
            <div id="weeklyList">
                <!-- Generated by JS -->
            </div>
        </div>
        
        <!-- Income Tab -->
        <div id="income" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Income Sources</h3>
                <button class="add-btn" onclick="addIncome()">+ Add Income</button>
            </div>
            
            <div class="section-title">Personal Income</div>
            <div id="personalIncomeList"></div>
            
            <div class="section-title business" style="margin-top: 30px;">Business Income</div>
            <div id="businessIncomeList"></div>
        </div>
        
        <!-- Expenses Tab -->
        <div id="expenses" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Expenses</h3>
                <button class="add-btn" onclick="addExpense()">+ Add Expense</button>
            </div>
            
            <div class="section-title">Personal Expenses</div>
            <div id="personalExpensesList"></div>
            
            <div class="section-title business" style="margin-top: 30px;">Business Expenses</div>
            <div id="businessExpensesList"></div>
        </div>
        
        <!-- Debts Tab -->
        <div id="debts" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Debt Payments</h3>
                <button class="add-btn" onclick="addDebt()">+ Add Debt</button>
            </div>
            
            <div class="section-title">Personal Debts</div>
            <div id="personalDebtsList"></div>
            
            <div class="section-title business" style="margin-top: 30px;">Business Debts</div>
            <div id="businessDebtsList"></div>
        </div>
    </div>
    
    <script>
        // Configuration
        const SHEET_ID = '1uvwP_yt9bUSNfxf_SV-TJy37IqxeTYW9zvu0rW7Jh4c';
        const SHEETS_BASE_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?`;
        
        // Data
        let startingCash = 20000;
        let incomeItems = [];
        let expenseItems = [];
        let debtItems = [];
        let isOnline = navigator.onLine;
        
        // Sync status management
        function updateSyncStatus(status, message) {
            const dot = document.getElementById('syncDot');
            const statusText = document.getElementById('syncStatus');
            
            dot.className = 'sync-dot';
            if (status === 'syncing') {
                dot.classList.add('syncing');
                statusText.textContent = message || 'Syncing...';
            } else if (status === 'error') {
                dot.classList.add('error');
                statusText.textContent = message || 'Sync Error';
            } else {
                statusText.textContent = message || 'Synced';
            }
            
            if (status === 'synced') {
                document.getElementById('lastSync').textContent = new Date().toLocaleTimeString();
            }
        }
        
        // Load data from Google Sheets
        async function loadFromSheets() {
            updateSyncStatus('syncing', 'Loading...');
            
            try {
                // Load Income
                const incomeResponse = await fetch(SHEETS_BASE_URL + 'sheet=Income');
                const incomeData = await incomeResponse.text();
                incomeItems = parseGoogleSheetData(incomeData);
                
                // Load Expenses
                const expenseResponse = await fetch(SHEETS_BASE_URL + 'sheet=Expenses');
                const expenseData = await expenseResponse.text();
                expenseItems = parseGoogleSheetData(expenseData);
                
                // Load Debts
                const debtResponse = await fetch(SHEETS_BASE_URL + 'sheet=Debts');
                const debtData = await debtResponse.text();
                debtItems = parseGoogleSheetData(debtData);
                
                // Load Settings
                const settingsResponse = await fetch(SHEETS_BASE_URL + 'sheet=Settings');
                const settingsData = await settingsResponse.text();
                const settings = parseGoogleSheetData(settingsData);
                
                if (settings.length > 0) {
                    const cashSetting = settings.find(s => s.key === 'startingCash');
                    if (cashSetting) {
                        startingCash = parseFloat(cashSetting.value) || 20000;
                        document.getElementById('startingCash').value = startingCash;
                    }
                }
                
                // Save to localStorage as backup
                saveToLocalStorage();
                
                updateSyncStatus('synced');
                return true;
            } catch (error) {
                console.error('Error loading from Sheets:', error);
                updateSyncStatus('error', 'Using Local Data');
                loadFromLocalStorage();
                return false;
            }
        }
        
        // Parse Google Sheets JSON response
        function parseGoogleSheetData(jsonString) {
            try {
                const json = JSON.parse(jsonString.substring(47).slice(0, -2));
                const rows = json.table.rows;
                
                if (!rows || rows.length <= 1) return [];
                
                const headers = rows[0].c.map(cell => cell ? cell.v : '');
                const data = [];
                
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row.c) continue;
                    
                    const item = {};
                    headers.forEach((header, index) => {
                        const cell = row.c[index];
                        if (cell && cell.v !== null) {
                            item[header] = cell.v;
                        }
                    });
                    
                    // Convert string booleans to actual booleans
                    if (item.enabled === 'TRUE' || item.enabled === true) item.enabled = true;
                    else if (item.enabled === 'FALSE' || item.enabled === false) item.enabled = false;
                    
                    // Convert numeric strings to numbers
                    if (item.id) item.id = parseInt(item.id);
                    if (item.amount) item.amount = parseFloat(item.amount);
                    if (item.taxRate) item.taxRate = parseFloat(item.taxRate);
                    if (item.balance) item.balance = parseFloat(item.balance);
                    if (item.payment) item.payment = parseFloat(item.payment);
                    if (item.interestRate) item.interestRate = parseFloat(item.interestRate);
                    
                    data.push(item);
                }
                
                return data;
            } catch (error) {
                console.error('Error parsing sheet data:', error);
                return [];
            }
        }
        
        // Save to Google Sheets (through form submission)
        async function saveToSheets() {
            updateSyncStatus('syncing');
            
            // Note: Direct writing to Google Sheets requires Google Sheets API
            // For simplicity, we'll save to localStorage and show instructions
            saveToLocalStorage();
            
            updateSyncStatus('synced');
        }
        
        // LocalStorage functions (backup)
        function saveToLocalStorage() {
            localStorage.setItem('financeData', JSON.stringify({
                startingCash,
                incomeItems,
                expenseItems,
                debtItems,
                lastSaved: new Date().toISOString()
            }));
        }
        
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('financeData');
            if (saved) {
                const data = JSON.parse(saved);
                startingCash = data.startingCash || 20000;
                incomeItems = data.incomeItems || getDefaultIncome();
                expenseItems = data.expenseItems || getDefaultExpenses();
                debtItems = data.debtItems || getDefaultDebts();
                
                document.getElementById('startingCash').value = startingCash;
            } else {
                // Load defaults
                incomeItems = getDefaultIncome();
                expenseItems = getDefaultExpenses();
                debtItems = getDefaultDebts();
            }
        }
        
        // Default data
        function getDefaultIncome() {
            return [
                { id: 1, name: 'Airbnb', amount: 1050, frequency: 'weekly', startDate: '2025-10-10', endDate: null, taxRate: 0.30, type: 'business', enabled: true },
                { id: 2, name: 'Wages', amount: 4000, frequency: 'biweekly', startDate: '2025-10-10', endDate: '2025-12-12', taxRate: 0, type: 'personal', enabled: true },
                { id: 3, name: 'Unemployment', amount: 350, frequency: 'weekly', startDate: '2025-10-10', endDate: '2026-01-02', taxRate: 0, type: 'personal', enabled: true }
            ];
        }
        
        function getDefaultExpenses() {
            return [
                { id: 1, name: 'Food', amount: 150, frequency: 'monthly', startDate: '2025-10-10', endDate: null, type: 'personal', enabled: true },
                { id: 2, name: 'Maria', amount: 350, frequency: 'monthly', startDate: '2025-10-10', endDate: null, type: 'personal', enabled: true },
                { id: 3, name: 'Medical Insurance', amount: 750, frequency: 'monthly', startDate: '2026-01-01', endDate: null, type: 'personal', enabled: true },
                { id: 4, name: 'Utilities', amount: 445, frequency: 'monthly', startDate: '2025-10-10', endDate: null, type: 'personal', enabled: true },
                { id: 5, name: 'Subscriptions', amount: 162, frequency: 'monthly', startDate: '2025-10-10', endDate: null, type: 'personal', enabled: true }
            ];
        }
        
        function getDefaultDebts() {
            return [
                { id: 1, name: 'Mortgage', balance: 10980, payment: 915, frequency: 'monthly', interestRate: 0.065, type: 'personal', enabled: true },
                { id: 2, name: 'American Express', balance: 6000, payment: 500, frequency: 'monthly', interestRate: 0.18, type: 'personal', enabled: true }
            ];
        }
        
        // Helper functions
        function getWeeklyAmount(amount, frequency) {
            const conversions = { 'weekly': 1, 'biweekly': 0.5, 'monthly': 0.23 };
            return amount * conversions[frequency];
        }
        
        function isItemActive(item, weekDate, weekIndex) {
            if (!item.enabled) return false;
            const start = new Date(item.startDate);
            const end = item.endDate ? new Date(item.endDate) : null;
            
            if (weekDate < start) return false;
            if (end && weekDate > end) return false;
            
            if (item.frequency === 'biweekly') {
                return weekIndex % 2 === 0;
            }
            
            return true;
        }
        
        function calculateWeeks() {
            const weeks = [];
            const startDate = new Date('2025-10-10');
            const endDate = new Date('2026-12-31');
            let current = new Date(startDate);
            let weekNum = 1;
            
            while (current <= endDate) {
                const weekEnd = new Date(current);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                weeks.push({
                    weekNum,
                    startDate: new Date(current),
                    endDate: weekEnd > endDate ? endDate : weekEnd
                });
                
                current.setDate(current.getDate() + 7);
                weekNum++;
            }
            
            return weeks;
        }
        
        function calculateFinancials() {
            const weeks = calculateWeeks();
            let cumulativeCash = startingCash;
            
            return weeks.map((week, idx) => {
                let grossIncome = 0;
                let expenses = 0;
                let debtPayments = 0;
                
                incomeItems.forEach(item => {
                    if (isItemActive(item, week.startDate, idx)) {
                        grossIncome += getWeeklyAmount(item.amount, item.frequency);
                    }
                });
                
                expenseItems.forEach(item => {
                    if (isItemActive(item, week.startDate, idx)) {
                        expenses += getWeeklyAmount(item.amount, item.frequency);
                    }
                });
                
                debtItems.forEach(debt => {
                    if (debt.enabled && isItemActive(debt, week.startDate, idx)) {
                        debtPayments += getWeeklyAmount(debt.payment, debt.frequency);
                    }
                });
                
                const netCashFlow = grossIncome - expenses - debtPayments;
                cumulativeCash += netCashFlow;
                
                return {
                    week: week.weekNum,
                    grossIncome: Math.round(grossIncome),
                    expenses: Math.round(expenses),
                    debtPayments: Math.round(debtPayments),
                    netCashFlow: Math.round(netCashFlow),
                    cumulativeCash: Math.round(cumulativeCash)
                };
            });
        }
        
        // UI Functions
        function switchTab(tabName, element) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (element) {
                element.classList.add('active');
            } else {
                event.target.classList.add('active');
            }
            document.getElementById(tabName).classList.add('active');
        }
        
        function renderDashboard() {
            const data = calculateFinancials();
            const outlookData = data.slice(0, 5);
            
            document.getElementById('currentCash').textContent = '$' + startingCash.toLocaleString();
            
            const outlookTable = document.getElementById('outlookTable');
            outlookTable.innerHTML = outlookData.map((week, idx) => `
                <tr style="${idx === 0 ? 'background: #dbeafe; font-weight: 600;' : ''}">
                    <td>${idx === 0 ? 'Current → ' : ''}Week ${week.week}</td>
                    <td class="text-right text-green">$${week.grossIncome.toLocaleString()}</td>
                    <td class="text-right">$${week.expenses.toLocaleString()}</td>
                    <td class="text-right">$${week.debtPayments.toLocaleString()}</td>
                    <td class="text-right ${week.netCashFlow >= 0 ? 'text-blue' : 'text-red'}" style="font-weight: bold;">
                        ${week.netCashFlow >= 0 ? '+' : ''}$${week.netCashFlow.toLocaleString()}
                    </td>
                    <td class="text-right" style="font-weight: bold;">$${week.cumulativeCash.toLocaleString()}</td>
                </tr>
            `).join('');
            
            const ctx = document.getElementById('cashChart').getContext('2d');
            if (window.cashChart) window.cashChart.destroy();
            
            window.cashChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.filter((_, i) => i % 2 === 0).map(d => `W${d.week}`),
                    datasets: [{
                        label: 'Cash Balance',
                        data: data.filter((_, i) => i % 2 === 0).map(d => d.cumulativeCash),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderWeekly() {
            const data = calculateFinancials();
            const weeklyList = document.getElementById('weeklyList');
            
            weeklyList.innerHTML = data.map(week => `
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-weight: 600;">Week ${week.week}</div>
                        <div style="display: flex; gap: 30px; font-size: 14px;">
                            <div class="text-right">
                                <div style="font-size: 11px; color: #6b7280;">Net Flow</div>
                                <div class="${week.netCashFlow >= 0 ? 'text-blue' : 'text-orange'}" style="font-weight: bold;">
                                    ${week.netCashFlow >= 0 ? '+' : ''}${week.netCashFlow.toLocaleString()}
                                </div>
                            </div>
                            <div class="text-right">
                                <div style="font-size: 11px; color: #6b7280;">Balance</div>
                                <div class="text-purple" style="font-weight: bold;">${week.cumulativeCash.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderIncome() {
            const personal = incomeItems.filter(i => i.type === 'personal');
            const business = incomeItems.filter(i => i.type === 'business');
            
            document.getElementById('personalIncomeList').innerHTML = personal.map(item => `
                <div class="item-row">
                    <input type="checkbox" ${item.enabled ? 'checked' : ''} onchange="toggleItem('income', ${item.id})">
                    <input type="text" value="${item.name}" onchange="updateItem('income', ${item.id}, 'name', this.value)">
                    <input type="number" value="${item.amount}" onchange="updateItem('income', ${item.id}, 'amount', this.value)">
                    <select onchange="updateItem('income', ${item.id}, 'frequency', this.value)">
                        <option value="weekly" ${item.frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                        <option value="biweekly" ${item.frequency === 'biweekly' ? 'selected' : ''}>Bi-weekly</option>
                        <option value="monthly" ${item.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                    </select>
                    <input type="date" value="${item.startDate}" onchange="updateItem('income', ${item.id}, 'startDate', this.value)">
                    <input type="date" value="${item.endDate || ''}" onchange="updateItem('income', ${item.id}, 'endDate', this.value)">
                    <button class="remove-btn" onclick="removeItem('income', ${item.id})">×</button>
                </div>
            `).join('');
            
            document.getElementById('businessIncomeList').innerHTML = business.map(item => `
                <div class="item-row">
                    <input type="checkbox" ${item.enabled ? 'checked' : ''} onchange="toggleItem('income', ${item.id})">
                    <input type="text" value="${item.name}" onchange="updateItem('income', ${item.id}, 'name', this.value)">
                    <input type="number" value="${item.amount}" onchange="updateItem('income', ${item.id}, 'amount', this.value)">
                    <select onchange="updateItem('income', ${item.id}, 'frequency', this.value)">
                        <option value="weekly" ${item.frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                        <option value="biweekly" ${item.frequency === 'biweekly' ? 'selected' : ''}>Bi-weekly</option>
                        <option value="monthly" ${item.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                    </select>
                    <input type="date" value="${item.startDate}" onchange="updateItem('income', ${item.id}, 'startDate', this.value)">
                    <input type="date" value="${item.endDate || ''}" onchange="updateItem('income', ${item.id}, 'endDate', this.value)">
                    <button class="remove-btn" onclick="removeItem('income', ${item.id})">×</button>
                </div>
            `).join('');
        }
        
        function renderExpenses() {
            const personal = expenseItems.filter(i => i.type === 'personal');
            const business = expenseItems.filter(i => i.type === 'business');
            
            document.getElementById('personalExpensesList').innerHTML = personal.map(item => `
                <div class="item-row">
                    <input type="checkbox" ${item.enabled ? 'checked' : ''} onchange="toggleItem('expense', ${item.id})">
                    <input type="text" value="${item.name}" onchange="updateItem('expense', ${item.id}, 'name', this.value)">
                    <input type="number" value="${item.amount}" onchange="updateItem('expense', ${item.id}, 'amount', this.value)">
                    <select onchange="updateItem('expense', ${item.id}, 'frequency', this.value)">
                        <option value="weekly" ${item.frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                        <option value="monthly" ${item.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                    </select>
                    <input type="date" value="${item.startDate}" onchange="updateItem('expense', ${item.id}, 'startDate', this.value)">
                    <input type="date" value="${item.endDate || ''}" onchange="updateItem('expense', ${item.id}, 'endDate', this.value)">
                    <button class="remove-btn" onclick="removeItem('expense', ${item.id})">×</button>
                </div>
            `).join('');
            
            document.getElementById('businessExpensesList').innerHTML = business.map(item => `
                <div class="item-row">
                    <input type="checkbox" ${item.enabled ? 'checked' : ''} onchange="toggleItem('expense', ${item.id})">
                    <input type="text" value="${item.name}" onchange="updateItem('expense', ${item.id}, 'name', this.value)">
                    <input type="number" value="${item.amount}" onchange="updateItem('expense', ${item.id}, 'amount', this.value)">
                    <select onchange="updateItem('expense', ${item.id}, 'frequency', this.value)">
                        <option value="weekly" ${item.frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                        <option value="monthly" ${item.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                    </select>
                    <input type="date" value="${item.startDate}" onchange="updateItem('expense', ${item.id}, 'startDate', this.value)">
                    <input type="date" value="${item.endDate || ''}" onchange="updateItem('expense', ${item.id}, 'endDate', this.value)">
                    <button class="remove-btn" onclick="removeItem('expense', ${item.id})">×</button>
                </div>
            `).join('');
        }
        
        function renderDebts() {
            const personal = debtItems.filter(i => i.type === 'personal');
            const business = debtItems.filter(i => i.type === 'business');
            
            document.getElementById('personalDebtsList').innerHTML = personal.map(item => `
                <div class="item-row" style="grid-template-columns: 40px 2fr 1fr 1fr 1fr 1fr 40px;">
                    <input type="checkbox" ${item.enabled ? 'checked' : ''} onchange="toggleItem('debt', ${item.id})">
                    <input type="text" value="${item.name}" onchange="updateItem('debt', ${item.id}, 'name', this.value)">
                    <input type="number" value="${item.balance}" onchange="updateItem('debt', ${item.id}, 'balance', this.value)">
                    <input type="number" value="${item.payment}" onchange="updateItem('debt', ${item.id}, 'payment', this.value)">
                    <select onchange="updateItem('debt', ${item.id}, 'frequency', this.value)">
                        <option value="weekly" ${item.frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                        <option value="monthly" ${item.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                    </select>
                    <input type="number" step="0.01" value="${(item.interestRate * 100).toFixed(2)}" onchange="updateItem('debt', ${item.id}, 'interestRate', this.value / 100)">
                    <button class="remove-btn" onclick="removeItem('debt', ${item.id})">×</button>
                </div>
            `).join('');
            
            document.getElementById('businessDebtsList').innerHTML = business.map(item => `
                <div class="item-row" style="grid-template-columns: 40px 2fr 1fr 1fr 1fr 1fr 40px;">
                    <input type="checkbox" ${item.enabled ? 'checked' : ''} onchange="toggleItem('debt', ${item.id})">
                    <input type="text" value="${item.name}" onchange="updateItem('debt', ${item.id}, 'name', this.value)">
                    <input type="number" value="${item.balance}" onchange="updateItem('debt', ${item.id}, 'balance', this.value)">
                    <input type="number" value="${item.payment}" onchange="updateItem('debt', ${item.id}, 'payment', this.value)">
                    <select onchange="updateItem('debt', ${item.id}, 'frequency', this.value)">
                        <option value="weekly" ${item.frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                        <option value="monthly" ${item.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                    </select>
                    <input type="number" step="0.01" value="${(item.interestRate * 100).toFixed(2)}" onchange="updateItem('debt', ${item.id}, 'interestRate', this.value / 100)">
                    <button class="remove-btn" onclick="removeItem('debt', ${item.id})">×</button>
                </div>
            `).join('');
        }
        
        // CRUD operations
        function toggleItem(type, id) {
            const items = type === 'income' ? incomeItems : type === 'expense' ? expenseItems : debtItems;
            const item = items.find(i => i.id === id);
            if (item) {
                item.enabled = !item.enabled;
                saveAndRender();
            }
        }
        
        function updateItem(type, id, field, value) {
            const items = type === 'income' ? incomeItems : type === 'expense' ? expenseItems : debtItems;
            const item = items.find(i => i.id === id);
            if (item) {
                if (field === 'amount' || field === 'balance' || field === 'payment' || field === 'taxRate' || field === 'interestRate') {
                    item[field] = parseFloat(value) || 0;
                } else {
                    item[field] = value;
                }
                saveAndRender();
            }
        }
        
        function removeItem(type, id) {
            if (type === 'income') {
                incomeItems = incomeItems.filter(i => i.id !== id);
            } else if (type === 'expense') {
                expenseItems = expenseItems.filter(i => i.id !== id);
            } else {
                debtItems = debtItems.filter(i => i.id !== id);
            }
            saveAndRender();
        }
        
        function addIncome() {
            const newId = Math.max(...incomeItems.map(i => i.id), 0) + 1;
            incomeItems.push({
                id: newId,
                name: 'New Income',
                amount: 0,
                frequency: 'monthly',
                startDate: '2025-10-10',
                endDate: null,
                taxRate: 0,
                type: 'personal',
                enabled: true
            });
            saveAndRender();
        }
        
        function addExpense() {
            const newId = Math.max(...expenseItems.map(i => i.id), 0) + 1;
            expenseItems.push({
                id: newId,
                name: 'New Expense',
                amount: 0,
                frequency: 'monthly',
                startDate: '2025-10-10',
                endDate: null,
                type: 'personal',
                enabled: true
            });
            saveAndRender();
        }
        
        function addDebt() {
            const newId = Math.max(...debtItems.map(i => i.id), 0) + 1;
            debtItems.push({
                id: newId,
                name: 'New Debt',
                balance: 0,
                payment: 0,
                frequency: 'monthly',
                interestRate: 0,
                type: 'personal',
                enabled: true
            });
            saveAndRender();
        }
        
        function updateStartingCash() {
            startingCash = parseFloat(document.getElementById('startingCash').value) || 20000;
            saveAndRender();
        }
        
        function saveAndRender() {
            saveToLocalStorage();
            saveToSheets();
            renderAll();
        }
        
        function renderAll() {
            renderDashboard();
            renderWeekly();
            renderIncome();
            renderExpenses();
            renderDebts();
        }
        
        function manualSync() {
            loadFromSheets().then(() => {
                renderAll();
            });
        }
        
        function downloadCSV() {
            const data = calculateFinancials();
            let csv = 'Week,Income,Expenses,Debt Payments,Net Cash Flow,Cumulative Cash\n';
            data.forEach(week => {
                csv += `${week.week},${week.grossIncome},${week.expenses},${week.debtPayments},${week.netCashFlow},${week.cumulativeCash}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'financial-forecast.csv';
            a.click();
        }
        
        // Initialize
        window.addEventListener('load', async () => {
            const loaded = await loadFromSheets();
            if (!loaded) {
                loadFromLocalStorage();
            }
            renderAll();
        });
        
        // Auto-save every 30 seconds
        setInterval(() => {
            if (navigator.onLine) {
                saveToLocalStorage();
            }
        }, 30000);
    </script>
</body>
</html>font-size: 11px; color: #6b7280;">Income</div>
                                <div class="text-green" style="font-weight: 600;">$${week.grossIncome.toLocaleString()}</div>
                            </div>
                            <div class="text-right">
                                <div style="font-size: 11px; color: #6b7280;">Outflow</div>
                                <div class="text-red" style="font-weight: 600;">$${(week.expenses + week.debtPayments).toLocaleString()}</div>
                            </div>
                            <div class="text-right">
                                <div style="
